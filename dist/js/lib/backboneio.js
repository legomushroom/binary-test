(function(e,t){typeof define=="function"&&define.amd?define(["backbone","socketio"],t):e.amdWeb=t(e.Backbone,e.io)})(this,function(e,t){function s(e,t,n){var r=function(){};return r.prototype=e.prototype,n||(n=[]),_.each(n,function(e){_.extend(r.prototype,e)}),t.prototype=new r,t.prototype.constructor=t,_.extend(t,e)}function o(e){var t=new u,r=e.backend;if(typeof r=="string")var i=r,s=undefined;else var i=r.name,s=r.channel;var o={name:i,channel:s,ready:function(e){t.then(e)}};return n.then(function(n){o.socket=n.of(i),o.socket.emit("listen",o.channel,function(n){o.options=n,o.socket.on("synced",function(t,n){var r=o.options.event;e.trigger(r,t,n),e.trigger(r+":"+t,n)}),t.resolve()})}),o}function u(e){this.context=e||this,this.callbacks=[],this.resolved=undefined}var n=new u;e.io=e.IO={connect:function(){var e=t.connect.apply(t,arguments);return n.resolve(e),e}};var r=e.sync;e.sync=function(e,t,n){var i=t.backend||t.collection&&t.collection.backend;n=_.clone(n);var s=n.error||function(){},o=n.success||function(){};if(!i)return r(e,t,n);delete n.error,delete n.success,i.ready(function(){var r={method:e,model:t.toJSON(),options:n};i.socket.emit("sync",r,function(e,t){e?s(e):o(t)})})};var i={bindBackend:function(){var e=this,t=this.model.prototype.idAttribute;this.backend.ready(function(){var n=e.backend.options.event;e.bind(n+":create",function(t){e.add(t)}),e.bind(n+":update",function(n){var r=e.get(n[t]);r&&r.set(n)}),e.bind(n+":delete",function(n){e.remove(n[t])})})}};return e.Collection=function(e){var t=function(){this.backend&&(this.backend=o(this)),e.apply(this,arguments)};return s(e,t,[i])}(e.Collection),u.prototype.then=function(e){this.resolved!==undefined?e.apply(this.context,this.resolved):this.callbacks.push(e)},u.prototype.resolve=function(){if(this.resolved)throw new Error("Promise already resolved");var e=this;this.resolved=arguments,_.each(this.callbacks,function(t){t.apply(e.context,e.resolved)})},e.io});